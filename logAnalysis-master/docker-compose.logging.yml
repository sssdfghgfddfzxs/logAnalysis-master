services:
  # Nginx web server (生成日志数据)
  nginx:
    image: nginx:alpine
    container_name: nginx-log-generator
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./html:/usr/share/nginx/html:ro
      - nginx_logs:/var/log/nginx
    networks:
      - log-analysis-network
    restart: unless-stopped

  # Filebeat (收集并发送日志)
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: filebeat-log-shipper
    user: root
    volumes:
      - ./filebeat-nginx.yml:/usr/share/filebeat/filebeat.yml:ro
      - nginx_logs:/var/log/nginx:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ELASTICSEARCH_HOSTS=http://localhost:8080
    networks:
      - log-analysis-network
    depends_on:
      - nginx
    restart: unless-stopped
    command: filebeat -e -strict.perms=false

  # 高级流量生成器
  traffic-generator:
    build:
      context: .
      dockerfile: Dockerfile.traffic
    container_name: advanced-traffic-generator
    networks:
      - log-analysis-network
    depends_on:
      - nginx
    environment:
      - NGINX_URL=http://nginx
      - API_URL=http://go-backend:8080
    restart: "no"
    command: python traffic_generator.py --type continuous --duration 30 --nginx-url http://nginx --api-url http://go-backend:8080

  # 简单流量生成器 (curl版本)
  simple-traffic:
    image: curlimages/curl:latest
    container_name: simple-traffic-generator
    networks:
      - log-analysis-network
    depends_on:
      - nginx
    restart: "no"
    command: >
      sh -c "
        echo '开始生成简单流量...'
        for i in \$$(seq 1 100); do
          echo \"请求 \$$i\"
          curl -s http://nginx/ > /dev/null
          curl -s http://nginx/api/test > /dev/null
          curl -s http://nginx/health > /dev/null
          curl -s http://nginx/nonexistent-\$$i > /dev/null
          sleep 2
        done
        echo '简单流量生成完成'
      "

volumes:
  nginx_logs:
    driver: local

networks:
  log-analysis-network:
    external: true